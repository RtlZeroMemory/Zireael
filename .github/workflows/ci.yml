name: ci

on:
  pull_request:
  push:

permissions:
  contents: read

# Cancel previous runs on the same branch/PR to free runners on re-push.
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # ── fast checks (< 1 min each) ──────────────────────────────────────
  # These three jobs are cheap and run in parallel.  Every expensive job
  # below gates on all three so a trivial guardrail / format / pin
  # failure never wastes 8+ compile runners.

  guardrails:
    name: guardrails
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y ripgrep
      - name: Run guardrails
        run: bash scripts/guardrails.sh

  version-pins:
    name: version pins
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check docs vs header pins
        run: python3 scripts/check_version_pins.py

  clang-format:
    name: linux / clang-format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang-format
      - name: Check formatting
        shell: bash
        run: |
          set -euo pipefail
          base="${{ github.event.before }}"
          head="${{ github.sha }}"
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            base="${{ github.event.pull_request.base.sha }}"
            head="${{ github.event.pull_request.head.sha }}"
          fi
          if [[ -z "${base}" || "${base}" == "0000000000000000000000000000000000000000" ]]; then
            # First push events may not provide a usable `before` SHA. Prefer
            # a local parent-commit diff before falling back to --all.
            if git rev-parse --verify "${head}^" >/dev/null 2>&1; then
              base="$(git rev-parse "${head}^")"
            fi
          fi
          if [[ -z "${base}" || "${base}" == "0000000000000000000000000000000000000000" ]]; then
            bash scripts/clang_format_check.sh --all
            exit 0
          fi
          bash scripts/clang_format_check.sh --diff "${base}" "${head}"

  # ── expensive jobs (gated on fast checks) ────────────────────────────

  clang-tidy:
    needs: [guardrails, version-pins, clang-format]
    name: linux / clang-tidy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang clang-tidy cmake ninja-build python3
      - name: Configure
        run: cmake --preset posix-clang-debug -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: clang-tidy
        run: python3 scripts/run_clang_tidy.py --build-dir out/build/posix-clang-debug

  linux-clang-debug:
    needs: [guardrails, version-pins, clang-format]
    name: linux / clang / Debug
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build
      - name: Configure
        run: cmake --preset posix-clang-debug -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset posix-clang-debug
      - name: Test
        run: ctest --test-dir out/build/posix-clang-debug --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-linux-clang-debug
          path: |
            out/build/posix-clang-debug/Testing/Temporary/**
            out/build/posix-clang-debug/CMakeCache.txt

  linux-gcc-debug:
    needs: [guardrails, version-pins, clang-format]
    name: linux / gcc / Debug
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y gcc cmake ninja-build
      - name: Configure
        run: cmake --preset posix-gcc-debug -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset posix-gcc-debug
      - name: Test
        run: ctest --test-dir out/build/posix-gcc-debug --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-linux-gcc-debug
          path: |
            out/build/posix-gcc-debug/Testing/Temporary/**
            out/build/posix-gcc-debug/CMakeCache.txt

  linux-clang-asan-ubsan:
    needs: [guardrails, version-pins, clang-format]
    name: linux / clang / Debug + ASan+UBSan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build
      - name: Configure
        run: cmake --preset posix-clang-asan-ubsan -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset posix-clang-asan-ubsan
      - name: Test
        env:
          ASAN_OPTIONS: detect_leaks=1
          UBSAN_OPTIONS: print_stacktrace=1
        run: ctest --test-dir out/build/posix-clang-asan-ubsan --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-linux-clang-asan-ubsan
          path: |
            out/build/posix-clang-asan-ubsan/Testing/Temporary/**
            out/build/posix-clang-asan-ubsan/CMakeCache.txt

  linux-clang-fuzz-extended:
    needs: [guardrails, version-pins, clang-format]
    name: linux / clang / fuzz extended
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build
      - name: Configure
        run: >-
          cmake --preset posix-clang-debug
          -DZIREAEL_WARNINGS_AS_ERRORS=ON
          -DZIREAEL_BUILD_EXAMPLES=OFF
          -DZIREAEL_BUILD_LIBFUZZER=ON
      - name: Build
        run: cmake --build --preset posix-clang-debug
      - name: Deterministic Fuzz (Extended Budget)
        env:
          ZR_FUZZ_ITERS: ${{ github.event_name == 'pull_request' && '5000' || '20000' }}
          ZR_FUZZ_MAX_SIZE: 2048
        run: >-
          ctest --test-dir out/build/posix-clang-debug
          --no-tests=ignore
          --output-on-failure
          -R '^zireael\\.fuzz\\.'
      - name: libFuzzer Smoke (Coverage-Guided)
        env:
          LIBFUZZ_RUNS: ${{ github.event_name == 'pull_request' && '2000' || '10000' }}
        run: |
          set -euo pipefail
          out/build/posix-clang-debug/tests/zireael_libfuzz_drawlist_parser -runs="${LIBFUZZ_RUNS}" >/dev/null
          out/build/posix-clang-debug/tests/zireael_libfuzz_input_parser -runs="${LIBFUZZ_RUNS}" >/dev/null
          out/build/posix-clang-debug/tests/zireael_libfuzz_utf8_decode -runs="${LIBFUZZ_RUNS}" >/dev/null
          out/build/posix-clang-debug/tests/zireael_libfuzz_grapheme_iter -runs="${LIBFUZZ_RUNS}" >/dev/null
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-linux-clang-fuzz-extended
          path: |
            out/build/posix-clang-debug/Testing/Temporary/**
            out/build/posix-clang-debug/CMakeCache.txt

  linux-clang-tsan:
    needs: [guardrails, version-pins, clang-format]
    name: linux / clang / Debug + TSan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install toolchain
        run: sudo apt-get update && sudo apt-get install -y clang cmake ninja-build
      - name: Configure
        run: cmake --preset posix-clang-tsan -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset posix-clang-tsan
      - name: Test
        env:
          TSAN_OPTIONS: halt_on_error=1 second_deadlock_stack=1
        run: ctest --test-dir out/build/posix-clang-tsan --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-linux-clang-tsan
          path: |
            out/build/posix-clang-tsan/Testing/Temporary/**
            out/build/posix-clang-tsan/CMakeCache.txt

  macos-appleclang-debug:
    needs: [guardrails, version-pins, clang-format]
    name: macos / AppleClang / Debug
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: brew install ninja
      - name: Configure
        run: cmake --preset posix-clang-debug -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset posix-clang-debug
      - name: Test
        run: ctest --test-dir out/build/posix-clang-debug --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-macos-appleclang-debug
          path: |
            out/build/posix-clang-debug/Testing/Temporary/**
            out/build/posix-clang-debug/CMakeCache.txt

  windows-clangcl-debug:
    needs: [guardrails, version-pins, clang-format]
    name: windows / clang-cl / Debug
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install tools
        run: choco install ninja --no-progress -y
      - name: MSVC dev cmd
        uses: ilammy/msvc-dev-cmd@v1
      - name: Configure
        run: cmake --preset windows-clangcl-debug -DZIREAEL_WARNINGS_AS_ERRORS=ON -DZIREAEL_BUILD_EXAMPLES=OFF
      - name: Build
        run: cmake --build --preset windows-clangcl-debug
      - name: Test
        run: ctest --test-dir out/build/windows-clangcl-debug --no-tests=ignore --output-on-failure
      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ctest-logs-windows-clangcl-debug
          path: |
            out/build/windows-clangcl-debug/Testing/Temporary/**
            out/build/windows-clangcl-debug/CMakeCache.txt
